# =============================================================================
# Query: Next Actions (GTD Style)
# =============================================================================
# Purpose: Find actionable tasks with no unfulfilled dependencies
# Returns: act, plan_name, context, priority_level, due_date
# Usage: GTD-style next actions list for daily planning
# Notes: A task is actionable if all its dependencies are completed or cancelled
# =============================================================================

PREFIX actions: <https://clearhead.us/vocab/actions/v4#>
PREFIX cco: <https://www.commoncoreontologies.org/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX bfo: <http://purl.obolibrary.org/obo/>

SELECT DISTINCT ?act ?plan_name ?context ?priority_level ?due_date WHERE {
    # Find not-started acts
    ?act a cco:ont00000228 ;
         actions:hasPhase actions:NotStarted .
    
    # Get the plan
    ?plan cco:ont00001942 ?act ;
          rdfs:label ?plan_name .
    
    # Check that all dependencies are satisfied
    FILTER NOT EXISTS {
        ?plan actions:dependsOn ?dep_plan .
        ?dep_plan cco:ont00001942 ?dep_act .
        ?dep_act actions:hasPhase ?dep_phase .
        FILTER(?dep_phase != actions:Completed && ?dep_phase != actions:Cancelled)
    }
    
    # Also check that parent plans (if any) don't block this
    FILTER NOT EXISTS {
        ?plan bfo:BFO_0000050 ?parent_plan .  # partOf
        ?parent_plan actions:hasSequentialChildren true .
        # Find previous sibling that's not complete
        ?parent_plan bfo:BFO_0000051 ?sibling_plan .  # hasPart
        ?sibling_plan cco:ont00001942 ?sibling_act .
        ?sibling_act actions:hasPhase ?sibling_phase .
        FILTER(?sibling_phase != actions:Completed && ?sibling_phase != actions:Cancelled)
        # This is a simplified check - full sequential logic is complex
    }
    
    # Get optional metadata
    OPTIONAL { ?plan actions:requiresContext ?context }
    OPTIONAL { 
        ?plan actions:hasPriority ?priority .
        ?priority cco:ont00001767 ?priority_level .
    }
    OPTIONAL { ?plan actions:hasDoDateTime ?due_date }
}
ORDER BY ?priority_level ?due_date ?plan_name
# =============================================================================
# Query: Dependency Chain
# =============================================================================
# Purpose: Traverse the full dependency graph to understand task relationships
# Parameters:
#   - ?ROOT_PLAN: Starting plan URI (e.g., <urn:uuid:some-plan-id>)
# Returns: plan, plan_name, dependency_level, depends_on_name
# Usage: Critical path analysis and project planning
# Notes: Uses SPARQL 1.1 property paths for transitive dependency traversal
# =============================================================================

PREFIX actions: <https://clearhead.us/vocab/actions/v4#>
PREFIX cco: <https://www.commoncoreontologies.org/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?plan ?plan_name ?dependency_level ?depends_on_name WHERE {
    # Start from root plan and traverse all dependencies
    # Parameter substitution: VALUES ?root_plan { <urn:uuid:some-plan-id> }
    VALUES ?root_plan { ?ROOT_PLAN }
    
    {
        # Level 0: Root plan itself
        BIND(?root_plan AS ?plan)
        BIND(0 AS ?dependency_level)
        BIND("" AS ?depends_on_name)
    } UNION {
        # Level 1+: Direct and indirect dependencies
        ?root_plan actions:dependsOn+ ?plan .
        ?plan actions:dependsOn ?direct_dep .
        
        # Calculate dependency level (simplified - counts direct deps)
        SELECT ?plan ?direct_dep (COUNT(*) AS ?dependency_level) WHERE {
            ?root_plan actions:dependsOn* ?plan .
            ?plan actions:dependsOn ?direct_dep .
        }
        GROUP BY ?plan ?direct_dep
        
        ?direct_dep rdfs:label ?depends_on_name .
    }
    
    # Get plan name
    ?plan rdfs:label ?plan_name .
}
ORDER BY ?dependency_level ?plan_name

# Note: This query is simplified. Full dependency level calculation 
# requires recursive traversal which is complex in SPARQL.
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix actions: <https://clearhead.us/vocab/actions/v3#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix schema: <http://schema.org/> .
@prefix bfo: <http://purl.obolibrary.org/obo/BFO_> .
@prefix cco: <https://www.commoncoreontologies.org/> .

#################################################################
#    SHACL Shapes for Actions Vocabulary v3
#    BFO/CCO-Aligned Ontology
#################################################################
#
# This file defines validation constraints for the Actions Vocabulary v3.
#
# KEY ARCHITECTURAL DISTINCTION:
# - ActionPlan (BFO Continuant) = information/directive that persists
# - ActionProcess (BFO Occurrent) = temporal execution of a plan
#
# One plan can prescribe multiple processes (recurring actions).
# Plans contain intention; processes contain actual execution data.
#
#################################################################

#################################################################
#    Common Property Shapes (Apply to Both Plans and Processes)
#################################################################

# UUID Validation Shape (Version 7 Format)
actions:UUIDShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan, actions:ActionProcess ;
    sh:property [
        sh:path actions:hasUUID ;
        sh:datatype xsd:string ;
        sh:pattern "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$" ;
        sh:message "UUID must be valid version 7 format (xxxxxxxx-xxxx-7xxx-xxxx-xxxxxxxxxxxx)" ;
    ] .

# Name Requirements Shape (using schema:name)
actions:NameShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan, actions:ActionProcess ;
    sh:property [
        sh:path schema:name ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
        sh:message "Action must have exactly one non-empty name" ;
    ] .

# Description Shape (using schema:description)
actions:DescriptionShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan, actions:ActionProcess ;
    sh:property [
        sh:path schema:description ;
        sh:datatype xsd:string ;
        sh:message "Description must be a string" ;
    ] .

#################################################################
#    ActionPlan-Specific Shapes (Planning/Intention)
#################################################################

# ActionPlan Priority Constraint (Eisenhower Matrix: 1-4)
actions:ActionPlanPriorityShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:hasPriority ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:maxInclusive 4 ;
        sh:message "Priority must be between 1 (urgent+important) and 4 (neither urgent nor important)" ;
    ] .

# ActionPlan Context Validation (GTD-style contexts)
actions:ActionPlanContextShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:hasContext ;
        sh:class actions:ActionContext ;
        sh:message "Context must reference an ActionContext individual" ;
    ] .

# Context Name Pattern (for context strings)
actions:ContextStringShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionContext ;
    sh:property [
        sh:path schema:name ;
        sh:datatype xsd:string ;
        sh:pattern "^@[a-zA-Z0-9_-]+$" ;
        sh:message "Context name should follow GTD format starting with @ (e.g., @phone, @computer, @office)" ;
    ] .

# Scheduled Do DateTime
actions:DoDateTimeShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:hasDoDateTime ;
        sh:datatype xsd:dateTime ;
        sh:message "Do date/time must be valid ISO 8601 dateTime" ;
    ] .

# Due DateTime
actions:DueDateTimeShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:hasDueDateTime ;
        sh:datatype xsd:dateTime ;
        sh:message "Due date/time must be valid ISO 8601 dateTime" ;
    ] .

# Estimated Duration
actions:DurationShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:hasDurationMinutes ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:maxInclusive 10080 ; # 7 days in minutes
        sh:message "Duration must be between 1 minute and 7 days (10080 minutes)" ;
    ] .

# Temporal Planning Consistency (do < due)
actions:PlanTemporalConsistencyShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:sparql [
        sh:select """
            PREFIX actions: <https://clearhead.us/vocab/actions/v3#>
            SELECT $this ?doDateTime ?dueDateTime
            WHERE {
                $this actions:hasDoDateTime ?doDateTime ;
                      actions:hasDueDateTime ?dueDateTime .
                FILTER(?doDateTime > ?dueDateTime)
            }
        """ ;
        sh:message "Planned do date/time cannot be after due date/time" ;
    ] .

#################################################################
#    Recurrence Shapes (Plan-Level - Plans Recur, Not Processes)
#################################################################

actions:RecurrenceFrequencyShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:hasRecurrenceFrequency ;
        sh:in ( "DAILY" "WEEKLY" "MONTHLY" "YEARLY" ) ;
        sh:message "Recurrence frequency must be DAILY, WEEKLY, MONTHLY, or YEARLY" ;
    ] .

actions:RecurrenceIntervalShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:hasRecurrenceInterval ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:message "Recurrence interval must be a positive integer" ;
    ] .

# Cannot have both recurrenceUntil and recurrenceCount
actions:RecurrenceTerminationShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:sparql [
        sh:select """
            PREFIX actions: <https://clearhead.us/vocab/actions/v3#>
            SELECT $this
            WHERE {
                $this actions:hasRecurrenceUntil ?until ;
                      actions:hasRecurrenceCount ?count .
            }
        """ ;
        sh:message "Action plan cannot have both recurrenceUntil and recurrenceCount - choose one termination method" ;
    ] .

#################################################################
#    ActionProcess-Specific Shapes (Execution/Reality)
#################################################################

# ActionProcess State (Quality that inheres in process)
actions:ActionProcessStateShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionProcess ;
    sh:property [
        sh:path actions:hasState ;
        sh:class actions:ActionState ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Action process must have exactly one state" ;
    ] .

# Actual Completion DateTime
actions:CompletedDateTimeShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionProcess ;
    sh:property [
        sh:path actions:hasCompletedDateTime ;
        sh:datatype xsd:dateTime ;
        sh:message "Completed date/time must be valid ISO 8601 dateTime" ;
    ] .

# Process prescribedBy Plan
actions:ProcessPrescribedByShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionProcess ;
    sh:property [
        sh:path cco:prescribed_by ;
        sh:class actions:ActionPlan ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Action process must be prescribed by exactly one action plan" ;
    ] .

# Process Temporal Consistency
actions:ProcessTemporalConsistencyShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionProcess ;
    sh:sparql [
        sh:select """
            PREFIX actions: <https://clearhead.us/vocab/actions/v3#>
            PREFIX cco: <https://www.commoncoreontologies.org/>
            SELECT $this ?doDateTime ?completedDateTime
            WHERE {
                # Get the plan that prescribes this process
                $this cco:prescribed_by ?plan .
                ?plan actions:hasDoDateTime ?doDateTime .

                # Get the completion time of the process
                $this actions:hasCompletedDateTime ?completedDateTime .

                # Check if completed before scheduled
                FILTER(?completedDateTime < ?doDateTime)
            }
        """ ;
        sh:message "Process completion date/time cannot be before the plan's scheduled do date/time" ;
    ] .

#################################################################
#    Hierarchical Shapes (Plan Hierarchy)
#################################################################

# Root Action Plan Shape
actions:RootActionPlanShape
    a sh:NodeShape ;
    sh:targetClass actions:RootActionPlan ;
    sh:property [
        sh:path actions:hasParentPlan ;
        sh:maxCount 0 ;
        sh:message "Root action plans cannot have parent plans" ;
    ] ;
    sh:property [
        sh:path actions:hasDepth ;
        sh:hasValue 0 ;
        sh:message "Root action plans must have depth 0" ;
    ] .

# Root plans can have project/story assignments
actions:RootActionPlanProjectShape
    a sh:NodeShape ;
    sh:targetClass actions:RootActionPlan ;
    sh:property [
        sh:path actions:belongsToProject ;
        sh:datatype xsd:string ;
        sh:message "Root action plans may have project assignments" ;
    ] .

# Child Action Plan Shape (depth 1-4)
actions:ChildActionPlanShape
    a sh:NodeShape ;
    sh:targetClass actions:ChildActionPlan ;
    sh:property [
        sh:path actions:hasParentPlan ;
        sh:or (
            [ sh:class actions:RootActionPlan ]
            [ sh:class actions:ChildActionPlan ]
        ) ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Child action plans must have exactly one parent (root or child plan)" ;
    ] ;
    sh:property [
        sh:path actions:belongsToProject ;
        sh:maxCount 0 ;
        sh:message "Child action plans cannot have project assignments (inherited from root)" ;
    ] ;
    sh:property [
        sh:path actions:hasDepth ;
        sh:minInclusive 1 ;
        sh:maxInclusive 4 ;
        sh:message "Child action plans must have depth between 1 and 4" ;
    ] .

# Leaf Action Plan Shape (depth 5)
actions:LeafActionPlanShape
    a sh:NodeShape ;
    sh:targetClass actions:LeafActionPlan ;
    sh:property [
        sh:path actions:hasParentPlan ;
        sh:class actions:ChildActionPlan ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Leaf action plans must have exactly one child action plan parent" ;
    ] ;
    sh:property [
        sh:path actions:belongsToProject ;
        sh:maxCount 0 ;
        sh:message "Leaf action plans cannot have project assignments (inherited from root)" ;
    ] ;
    sh:property [
        sh:path actions:hasDepth ;
        sh:hasValue 5 ;
        sh:message "Leaf action plans must have depth 5" ;
    ] ;
    sh:property [
        sh:path actions:hasChildPlan ;
        sh:maxCount 0 ;
        sh:message "Leaf action plans cannot have children" ;
    ] .

# Maximum Depth Constraint (no more than 5 levels of nesting)
actions:MaxDepthConstraint
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:sparql [
        sh:select """
            PREFIX actions: <https://clearhead.us/vocab/actions/v3#>
            SELECT $this
            WHERE {
                # Check for 6+ levels of parent chain
                $this actions:hasParentPlan/
                      actions:hasParentPlan/
                      actions:hasParentPlan/
                      actions:hasParentPlan/
                      actions:hasParentPlan/
                      actions:hasParentPlan ?sixthAncestor .
            }
        """ ;
        sh:message "Action plans cannot exceed 5 levels of nesting (depth 0-5)" ;
    ] .

# Depth Consistency Validation
actions:DepthConsistencyShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:sparql [
        sh:select """
            PREFIX actions: <https://clearhead.us/vocab/actions/v3#>
            SELECT $this ?depth
            WHERE {
                $this actions:hasDepth ?depth .

                # Count actual ancestors
                OPTIONAL {
                    $this actions:hasParentPlan ?p1 .
                    OPTIONAL {
                        ?p1 actions:hasParentPlan ?p2 .
                        OPTIONAL {
                            ?p2 actions:hasParentPlan ?p3 .
                            OPTIONAL {
                                ?p3 actions:hasParentPlan ?p4 .
                                OPTIONAL {
                                    ?p4 actions:hasParentPlan ?p5 .
                                }
                            }
                        }
                    }
                }

                # Compute actual depth from parent chain
                BIND(
                    IF(!BOUND(?p1), 0,
                    IF(!BOUND(?p2), 1,
                    IF(!BOUND(?p3), 2,
                    IF(!BOUND(?p4), 3,
                    IF(!BOUND(?p5), 4, 5)))))
                AS ?actualDepth)

                # Check if declared depth matches actual depth
                FILTER(?depth != ?actualDepth)
            }
        """ ;
        sh:message "Declared depth must match actual depth in parent chain" ;
    ] .

#################################################################
#    Workflow Dependency Shapes
#################################################################

# Dependency validation (cannot depend on self)
actions:DependencyShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:sparql [
        sh:select """
            PREFIX actions: <https://clearhead.us/vocab/actions/v3#>
            SELECT $this
            WHERE {
                $this actions:dependsOn $this .
            }
        """ ;
        sh:message "Action plan cannot depend on itself" ;
    ] .

# Circular dependency detection (simple 2-level check)
actions:CircularDependencyShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:sparql [
        sh:select """
            PREFIX actions: <https://clearhead.us/vocab/actions/v3#>
            SELECT $this ?dependency
            WHERE {
                $this actions:dependsOn ?dependency .
                ?dependency actions:dependsOn $this .
            }
        """ ;
        sh:message "Circular dependency detected (A depends on B, B depends on A)" ;
    ] .

#################################################################
#    Agent Assignment Shapes
#################################################################

actions:AssignedAgentShape
    a sh:NodeShape ;
    sh:targetClass actions:ActionPlan ;
    sh:property [
        sh:path actions:assignedToAgent ;
        sh:class cco:Agent ;
        sh:message "Assigned agent must be a CCO Agent" ;
    ] .

#################################################################
#    State Enumeration Validation
#################################################################

# Note: State validation is handled by sh:class constraints in ActionProcessStateShape.
# We don't need to validate rdf:type here as it creates issues with ontology inference
# where states have multiple types (ActionState, BFO Quality, owl:NamedIndividual, etc.)

#################################################################
#    End of SHACL Shapes for Actions Vocabulary v3
#################################################################

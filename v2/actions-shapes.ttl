@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix actions: <https://vocab.example.org/actions/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix schema: <http://schema.org/> .

# UUID Validation Shape
actions:UUIDShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:property [
        sh:path actions:uuid ;
        sh:datatype xsd:string ;
        sh:pattern "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$" ;
        sh:message "UUID must be valid version 7 format (xxxxxxxx-xxxx-7xxx-xxxx-xxxxxxxxxxxx)" ;
    ] .

# Name Requirements Shape  
actions:NameShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:property [
        sh:path schema:name ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
        sh:message "Action must have exactly one non-empty name" ;
    ] .
#################################################################
#    SHACL Shapes for Actions Vocabulary
#################################################################

# Base Action Shape - applies to all actions
actions:ActionShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:property [
        sh:path actions:priority ;
        sh:datatype xsd:integer ;
        sh:minCount 1 ;
        sh:minInclusive 1 ;
        sh:maxInclusive 4 ;
        sh:message "Action must have exactly one priority value between 1 and 4 (Eisenhower matrix)" ;
    ] ;
    sh:property [
        sh:path actions:context ;
        sh:datatype xsd:string ;
        sh:message "Context must be string values" ;
    ] ;
    sh:property [
        sh:path actions:state ;
        sh:class actions:ActionState ;
        sh:minCount 1 ;
        sh:message "Action must have exactly one state" ;
    ] .

# Root Action Shape - depth 0
actions:RootActionShape
    a sh:NodeShape ;
    sh:targetClass actions:RootAction ;
    sh:property [
        sh:path actions:parentAction ;
        sh:maxCount 0 ;
        sh:message "Root actions cannot have parents" ;
    ] ;
    sh:property [
        sh:path actions:project ;
        sh:datatype xsd:string ;
        sh:message "Root actions may have project assignments" ;
    ] .

# Child Action Shape - depth 1-4
actions:ChildActionShape
    a sh:NodeShape ;
    sh:targetClass actions:ChildAction ;
    sh:property [
        sh:path actions:parentAction ;
        sh:or (
            [ sh:class actions:RootAction ]
            [ sh:class actions:ChildAction ]
        ) ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Child actions must have exactly one parent (root or child action)" ;
    ] ;
    sh:property [
        sh:path actions:project ;
        sh:maxCount 0 ;
        sh:message "Child actions cannot have project assignments" ;
    ] .

# Leaf Action Shape - depth 5
actions:LeafActionShape
    a sh:NodeShape ;
    sh:targetClass actions:LeafAction ;
    sh:property [
        sh:path actions:parentAction ;
        sh:class actions:ChildAction ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Leaf actions must have exactly one child action parent" ;
    ] ;
    sh:property [
        sh:path actions:project ;
        sh:maxCount 0 ;
        sh:message "Leaf actions cannot have project assignments" ;
    ] .

# Maximum depth constraint (no more than 5 levels of nesting)
actions:MaxDepthConstraint
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:sparql [
        sh:select """
            SELECT $this
            WHERE {
                $this actions:parentAction/actions:parentAction/actions:parentAction/actions:parentAction/actions:parentAction/actions:parentAction ?greatGreatGreatGreatGrandparent .
            }
        """ ;
        sh:message "Actions cannot exceed 5 levels of nesting" ;
    ] .

# Depth consistency validation (when depth is specified)
actions:DepthConsistencyShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:sparql [
        sh:select """
            SELECT $this
            WHERE {
                # Check for depth 0 claiming to have parents
                { $this actions:depth 0 ; actions:parentAction ?parent . }
                UNION
                # Check for depth 5 not having exactly 5 ancestors  
                { $this actions:depth 5 . 
                  FILTER NOT EXISTS { 
                    $this actions:parentAction/actions:parentAction/actions:parentAction/actions:parentAction/actions:parentAction ?ancestor .
                    FILTER NOT EXISTS { ?ancestor actions:parentAction ?grandparent }
                  }
                }
            }
        """ ;
        sh:message "Depth specification inconsistent with actual parent chain" ;
    ] .

# Class-depth consistency
actions:RootDepthConsistency
    a sh:NodeShape ;
    sh:targetClass actions:RootAction ;
    sh:sparql [
        sh:select """
            SELECT $this
            WHERE {
                $this actions:depth ?depth .
                FILTER(?depth != 0)
            }
        """ ;
        sh:message "RootAction depth, when specified, must be 0" ;
    ] .

actions:LeafDepthConsistency
    a sh:NodeShape ;
    sh:targetClass actions:LeafAction ;
    sh:sparql [
        sh:select """
            SELECT $this
            WHERE {
                $this actions:depth ?depth .
                FILTER(?depth != 5)
            }
        """ ;
        sh:message "LeafAction depth, when specified, must be 5" ;
    ] .

actions:ChildDepthConsistency
    a sh:NodeShape ;
    sh:targetClass actions:ChildAction ;
    sh:sparql [
        sh:select """
            SELECT $this
            WHERE {
                $this actions:depth ?depth .
                FILTER(?depth < 1 || ?depth > 4)
            }
        """ ;
        sh:message "ChildAction depth, when specified, must be between 1 and 4" ;
    ] .
# Root Action Project Constraint
actions:RootActionProjectShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:sparql [
        sh:select """
            SELECT $this ?project
            WHERE {
                $this actions:project ?project .
                FILTER NOT EXISTS { $this a actions:RootAction }
            }
        """ ;
        sh:message "Only root actions can have project assignments" ;
    ] .

# Context Array Validation Shape
actions:ContextArrayShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:property [
        sh:path actions:context ;
        sh:datatype xsd:string ;
        sh:pattern "^@[a-zA-Z0-9_-]+$" ;
        sh:message "Context should follow GTD format starting with @ (e.g., @phone, @computer, @errands)" ;
    ] .

# Recurrence Validation Shape
actions:RecurrenceShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:property [
        sh:path actions:recurrenceFrequency ;
        sh:in ( "DAILY" "WEEKLY" "MONTHLY" "YEARLY" ) ;
        sh:message "Recurrence frequency must be DAILY, WEEKLY, MONTHLY, or YEARLY" ;
    ] ;
    sh:property [
        sh:path actions:recurrenceInterval ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:message "Recurrence interval must be a positive integer" ;
    ] ;
    sh:sparql [
        sh:select """
            SELECT $this
            WHERE {
                $this actions:recurrenceUntil ?until ;
                      actions:recurrenceCount ?count .
            }
        """ ;
        sh:message "Action cannot have both recurrenceUntil and recurrenceCount - choose one termination method" ;
    ] .

# Duration Validation Shape
actions:DurationShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:property [
        sh:path actions:durationMinutes ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:maxInclusive 10080 ; # 7 days in minutes
        sh:message "Duration must be between 1 minute and 7 days (10080 minutes)" ;
    ] .

# Temporal Consistency Shape
actions:TemporalConsistencyShape
    a sh:NodeShape ;
    sh:targetClass actions:Action ;
    sh:sparql [
        sh:select """
            SELECT $this ?doDateTime ?completedDateTime
            WHERE {
                $this actions:doDateTime ?doDateTime ;
                      actions:completedDateTime ?completedDateTime .
                FILTER(?completedDateTime < ?doDateTime)
            }
        """ ;
        sh:message "Completion date/time cannot be before scheduled do date/time" ;
    ] ;
    sh:sparql [
        sh:select """
            SELECT $this ?dueDateTime ?completedDateTime
            WHERE {
                $this actions:dueDateTime ?dueDateTime ;
                      actions:completedDateTime ?completedDateTime .
                FILTER(?completedDateTime > ?dueDateTime)
            }
        """ ;
        sh:message "Completion date/time should not be after due date/time (indicates missed deadline)" ;
    ] ;
    sh:sparql [
        sh:select """
            SELECT $this ?doDateTime ?dueDateTime
            WHERE {
                $this actions:doDateTime ?doDateTime ;
                      actions:dueDateTime ?dueDateTime .
                FILTER(?doDateTime > ?dueDateTime)
            }
        """ ;
        sh:message "Do date/time cannot be after due date/time" ;
    ] .
